#!/usr/bin/env python
# -*- coding: utf-8

# Copyright (C) 2014, PaPi Authors
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your option)
# any later version.
#
# Please read the COPYING file.

import os
import sys
import cPickle
import PaPi.utils


def reset_output_dir(runinfo_dict_path, cwd=None):
    try:
        runinfo_dict = cPickle.load(open(runinfo_dict_path))
    except:
        raise PaPi.utils.ConfigError, "The input file ('%s') does not seem to be a cPickle object." % (runinfo_dict_path)

    cwd = os.getcwd()

    new_output_dir = os.path.dirname(os.path.join(cwd, runinfo_dict_path))
    old_output_dir = runinfo_dict['output_dir']

    for key in runinfo_dict.keys():
        if isinstance(runinfo_dict[key], str):
            runinfo_dict[key] = runinfo_dict[key].replace(old_output_dir, new_output_dir)

    cPickle.dump(runinfo_dict, open(runinfo_dict_path, 'w'))


if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(description='Set output directory in a RUNINFO.cPickle that was transfered from another computer')
    parser.add_argument('runinfo_dict_path', metavar = 'RUNINFO_DICT',
                        help = 'RUNINFO dict generated by PaPi profiler')

    args = parser.parse_args()

    try:
        sys.exit(reset_output_dir(args.runinfo_dict_path))
    except PaPi.utils.ConfigError, e:
        print e
        sys.exit(-1)
