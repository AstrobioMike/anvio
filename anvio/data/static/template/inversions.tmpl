<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Anvi'o">
    <base target="_blank">

    <title>Anvi'o: Inversions Summary</title>

    <!-- JQUERY -->
    <script src=".html/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src=".html/js/bootstrap.min.js"></script>

    <!-- Bootstrap Core CSS -->
    <link href=".html/css/bootstrap.css" rel="stylesheet">
    <link href=".html/bootstrap-sortable/Contents/bootstrap-sortable.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href=".html/css/anvio.css" rel="stylesheet">
</head>

<body>

    <header class="image-bg-fluid-height" style="padding: 10px 0px;">
        <div class="header-summary-div">
            <div style="width: 200px;">
                <a href="https://anvio.org" target="_blank"><img class="img-responsive img-left"src=".html/pics/logo.png" alt=""></a>
            </div>
            <div class="header-text">
                Welcome to the <a href="https://anvio.org" target="_blank">anvi'o</a> summary page for inversions. The contents of this page is generated by
                <a href="https://anvio.org/m/anvi-report-inversions" target="_blank">anvi-report-inversions</a>, which not only produces this static HTML summary page
                but also a more comprehensive <a href="https://anvio.org/m/inversions-txt" target="_blank">text output files</a> for downstream analyses. In addition
                to some of the text output the program generates, below you will find a summary of the total of {{ meta.num_inversions }} inversions, their genomic
                context, and their activity accross {{ meta.num_samples }} samples. Please note that the anvi'o inversions submodule is still relatively young and
                experimental. If you have any questions, please feel free to write to <a href="https://anvio.org/m/anvi-report-inversions" target="_blank">its developers</a>.
            </div>
        </div>
    </header>

    <section>
        <div class="container">
            <div class="panel panel-warning" id="Summary">
                <div class="panel-heading">
                    <h1 class="panel-title">All Inversions</h1>
                </div>
                <div id="collapse-bins" class="panel-collapse">
                    <div class="panel-body">
                        <p>To view or download the TAB-delimited file that summarizes all consensus inversions, please <a href="{{ files|lookup:"consensus_inversions" }}">click here</a>.
                        <p>See the anvi'o artifact <a href="https://anvio.org/m/inversions-txt" target="_blank">inversion-txt</a> to learn more about the information shown in this file.
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% for inversion in inversions %}
    <section>
        <div class="container">
            <div class="panel panel-info" id="{{ inversion }}">
                <div class="panel-heading">
                    <h1 class="panel-title">{{ inversion|pretty }}</h1>
                </div>
                <div id="collapse-bins" class="panel-collapse">
                    <div class="panel-body">

                        <h3>Genomic context <small class="text-muted">:: What we know about the genes that surrounds it.</small></h3>

                        <p>The figure below shows the location of the inversion and the genes that surround it in the genome. You can find a table with more information about <a href="{{ files|lookup:inversion|lookup:"genes" }}">the genes</a> and <a href="{{ files|lookup:inversion|lookup:"functions" }}">their functions</a>.

                        <div style="width:1000px; margin:auto; background:#F1F1F1; border-radius:10px 20px; border:1px solid #c8c8c8; margin-top: 25px; margin-bottom: 25px;">
                        <svg width="1000" height="80">

                        {% if meta.genomic_context_recovered %}
                            <!-- Mark the inversion site -->
                            <rect x="{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"IX" }}" y="0" width="{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"IW" }}" height="65" style="fill:red; opacity:0.5"></rect>
                            <text x="{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"IT" }}" y="75" dominant-baseline="middle" text-anchor="middle" fill="red" style="font-weight:bold;">{{ inversion|humanize}}</text>

                            <!-- Go through genes to be shown in the genomic context -->
                            {% for gene in inversions|lookup:inversion|lookup:"genes" %}
                                {% if gene|lookup:"direction" == "r" %}<g type="button" class="btn btn-primary" data-container="body" data-toggle="popover" data-popover-content='#{{inversion}}-gene-{{ gene|lookup:"gene_callers_id" }}-popover' data-placement="bottom" transform='translate({{ gene|lookup:"GTRANS" }}, 0) scale(-1, 1)' id="{{inversion}}-gene-{{ gene|lookup:"gene_callers_id" }}">{% else %}<g type="button" class="btn btn-primary" data-container="body" data-toggle="popover" data-popover-content='#{{inversion}}-gene-{{ gene|lookup:"gene_callers_id" }}-popover' data-placement="bottom" id="{{inversion}}-gene-{{ gene|lookup:"gene_callers_id" }}">{% endif %}
                                <rect x="{{ gene|lookup:"RX" }}" y="23" width="{{ gene|lookup:"RW" }}" height="15" style="fill:{{ gene|lookup:"COLOR" }}"></rect>
                                <polygon points="{{ gene|lookup:"RX_RW" }} 12, {{ gene|lookup:"GY" }} 30, {{ gene|lookup:"RX_RW" }} 48" style="fill:{{ gene|lookup:"COLOR" }}"></polygon>
                                </g>

                                {% if forloop.counter0|even_odd == 0 %}
                                <text x="{{ gene|lookup:"CX" }}" y="55" dominant-baseline="middle" text-anchor="middle" fill="black" style="font-weight:bold;">{{ gene|lookup:"gene_callers_id" }}</text>
                                {% else %}
                                <text x="{{ gene|lookup:"CX" }}" y="12" dominant-baseline="middle" text-anchor="middle" fill="black" style="font-weight:bold;">{{ gene|lookup:"gene_callers_id" }}</text>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <text x="50%" y="35" dominant-baseline="middle" text-anchor="middle" fill="gray" style="font-style:italic;">We don't know anything about the genomic context since you have used the flag `--skip-recovering-genomic-context` (#SAD)</text>
                        {% endif %}

                        </svg>

                        {% if meta.genomic_context_recovered %}
                        <!-- If the metagenomic context is recovered, we also want to populate some `divs` that hold information
                             for the gene calls. Below we have a set of hidden divs to be shown for each gene -->
                        {% for gene in inversions|lookup:inversion|lookup:"genes" %}
                        <!-- Popover Template -->
                        <div class="hidden popover fade in top col-12" role="tooltip" id="{{inversion}}-gene-{{ gene|lookup:'gene_callers_id' }}-popover">
                            <div class="popover-body table-responsive">
                                <div class="panel panel-default" id="popover-panel">
                                    <div class="panel-heading mt-2" style="width: 100%;">
                                        <h4>Gene Call</h4>
                                    </div>
                                    <div class="panel-body">
                                        <table class="table table-striped gene-call-table" style="width: 100%; text-align: center;">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Source</th>
                                                    <th>Contig</th>
                                                    <th>Length</th>
                                                    <th>Direction</th>
                                                    <th>Start</th>
                                                    <th>Stop</th>
                                                    <th>Call type</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>{{ gene|lookup:"gene_callers_id"|pretty }}</td>
                                                    <td>{{ gene|lookup:"source"|pretty }}</td>
                                                    <td>{{ gene|lookup:"contig"|pretty }}</td>
                                                    <td>{{ gene|lookup:"length"|pretty }}</td>
                                                    <td>{{ gene|lookup:"direction"|pretty }}</td>
                                                    <td>{{ gene|lookup:"start"|pretty }}</td>
                                                    <td>{{ gene|lookup:"stop"|pretty }}</td>
                                                    <td>{{ gene|lookup:"call_type"|pretty }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- DNA/AA buttons -->
                                    <div class="row seq-buttons">
                                        <div class="col-xs-1 gene-section">
                                            <button type="button" class="btn btn-default btn-sm" onClick="show_sequence('{{ gene|lookup:'header'|pretty }}', '{{ gene|lookup:'DNA_sequence'|pretty }}')">DNA</button>
                                        </div>
                                        <div class="col-xs-1 gene-section">
                                            <button type="button" class="btn btn-default btn-sm" onClick="show_aa_sequence('{{ gene|lookup:'header'|pretty }}', '{{ gene|lookup:'AA_sequence'|pretty }}')">AA</button>
                                        </div>
                                    </div>
                                    <div class="panel-heading mt-2" style="width: 100%;">
                                        <h4>Function Annotations</h4>
                                    </div>
                                    <div class="panel-body">
                                        {% if gene|lookup:"has_functions" %}
                                        <table class="table table-striped" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>Source</th>
                                                    <th>Accession</th>
                                                    <th>Function</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for function in gene|lookup:"functions" %}
                                                <tr>
                                                    <td class="long">{{ function|lookup:"source"|pretty }}</td>
                                                    <td>{{ function|lookup:"accession"|pretty }}</td>
                                                    <td class="long">{{ function|lookup:"function"|pretty }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% else %}
                                        <p>No known function in {{ meta|lookup:"gene_function_sources"|pretty_join:"or" }} :/
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% endfor %}
                        {% endif %}

                        </div>

                        <h3 style="margin-bottom: 25px">Activity <small class="text-muted">:: How does it behave across samples</small></h3>

                        <p>The figures below show the relative proportion of the orientation of this inversion in each sample. For each sample, anvi'o produces two plots to quantify the
                        proportion of each end of the inversion based on short read recruitment results. For more information, see <a href="https://anvio.org/m/anvi-report-inversions">the help page</a>

                        {% if meta.inversion_activity_computed %}
                            {% for sample in inversions|lookup:inversion|lookup:"activity" %}
                                <div style="width:1008px; display:flex; justify-content: center; margin:auto; background:#F1F1F1; border:1px solid #c8c8c8; margin-top: 30px; margin-bottom: 10px">
                                <svg width="1000" height="66">
                                <text x="5" y="15" fill="black" style="font-weight:bold;">{{ sample }}</text>
                                {% for oligo_primer in inversions|lookup:inversion|lookup:"activity"|lookup:sample %}
                                    {% for oligo in inversions|lookup:inversion|lookup:"activity"|lookup:sample|lookup:oligo_primer %}
                                    <rect x="{{ inversions|lookup:inversion|lookup:"activity"|lookup:sample|lookup:oligo_primer|lookup:oligo|lookup:"start" }}" y="{{ inversions|lookup:inversion|lookup:"activity"|lookup:sample|lookup:oligo_primer|lookup:oligo|lookup:"y_coord" }}" width="{{ inversions|lookup:inversion|lookup:"activity"|lookup:sample|lookup:oligo_primer|lookup:oligo|lookup:"width" }}" height="20" style="fill:{{ inversions|lookup:inversion|lookup:"activity"|lookup:sample|lookup:oligo_primer|lookup:oligo|lookup:"color" }}"></rect>
                                    {% endfor %}
                                {% endfor %}
                                </svg>
                                </div>
                            {% endfor %}
                            <div style="width:300px; display:flex; justify-content: center; margin:auto; margin-top: 10px; margin-bottom: 10px">
                                <svg width="300" height="50">
                                <rect x="10" y="10" width="25" height="25" style="fill:#53B8BB"></rect>
                                <text x="40" y="27" width="25" height="25" fill="black">Reference</text>
                                <rect x="150" y="10" width="25" height="25" style="fill:#055052"></rect>
                                <text x="180" y="27" width="25" height="25" fill="black">Inversion</text>
                                </svg>
                            </div>
                        {% else %}
                            <div style="width:1008px; display:flex; justify-content: center; margin:auto; background:#F1F1F1; border:1px solid #c8c8c8; margin-top: 10px; margin-bottom: 10px">
                            <svg width="1000" height="66">
                            <text x="50%" y="30" dominant-baseline="middle" text-anchor="middle" fill="gray" style="font-style:italic;">We don't know anything about the activity since you have used the flag `--skip-compute-inversion-activity` (#SAD)</text>
                            </svg>
                        </div>
                        {% endif %}

                        <h3>Details <small class="text-muted">:: What we know about this inversion</small></h3>

                        <div class="panel panel-default" style="margin-right:10px; margin-left:10px;">
                            <div class="panel-heading">
                                General Information
                            </div>
                            <div class="panel-body">
                                <table class="table table-striped">
                                    <thead id="{{ inversion }}-table">
                                    <tbody>
                                        <tr>
                                            <td width="25%">Inversion name</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"inversion_id" }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Contig in which it was found</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"contig_name" }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Length of the inversion</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"distance"|pretty }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Number of samples observed</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"num_samples" }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Sample in which it was observed</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"sample_names" }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- SUMMARY OF THE INVERTED REPEATS -->
                        <div class="panel panel-default" style="margin-right:10px; margin-left:10px;">
                            <div class="panel-heading">
                                Inverted Repeats
                            </div>
                            <div class="panel-body">
                                <table class="table table-hover">
                                    <thead id="{{ inversion }}-table">
                                    <tbody>
                                        <tr class="table-active">
                                            <td width="25%" style="border: none; text-align:right;">First Inverted Repeat<br/>&nbsp;<br/>Second Inverted Repeat</td>
                                            <td style="border: none;">
                                                {{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"first_seq"|monospace|safe }}<br />
                                                {{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"midline"|monospace|safe }}<br />
                                                {{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"second_seq"|monospace|safe }}</td>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="panel-body">
                                <table class="table table-striped">
                                    <thead id="{{ inversion }}-table">
                                    <tbody>
                                        <tr>
                                            <td width="25%">Length of the inverted repeats</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"length"|pretty }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Number of mismatches</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"num_mismatches" }}</td>
                                        </tr>
                                        <tr>
                                            <td width="25%">Number of gaps</td>
                                            <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"num_gaps" }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Side by side tables -->
                            <div class="row">
                                <div class="table-responsive col-md-6">
                                    <div class="panel panel-default" style="margin-right:10px; margin-left:10px;">
                                        <div class="panel-heading">
                                            First Inverted Repeat
                                        </div>
                                        <div class="panel-body">
                                            <table class="table table-striped">
                                                <tbody>
                                                    <tr>
                                                        <td width="25%">Start</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"first_start"|pretty }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">End</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"first_end"|pretty }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">Primer</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"first_oligo_primer"|monospace|safe }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">Reference</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"first_oligo_reference"|monospace|safe }}</td>
                                                    </tr>
                                                </tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive col-md-6">
                                    <div class="panel panel-default" style="margin-right:10px; margin-left:10px;">
                                        <div class="panel-heading">
                                            Second Inverted Repeat
                                        </div>
                                        <div class="panel-body">
                                            <table class="table table-striped">
                                                <tbody>
                                                    <tr>
                                                        <td width="25%">Start</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"second_start"|pretty }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">End</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"second_end"|pretty }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">Primer</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"second_oligo_primer"|monospace|safe }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td width="25%">Reference</td>
                                                        <td>{{ inversions|lookup:inversion|lookup:"inversion_data"|lookup:"second_oligo_reference"|monospace|safe }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endfor %}
<style>
    .popover {
        min-width: 600px;
        max-width: 750px;
    }
    .popover-content{
        padding: 0px;
    }
    .popover-table th, td {
        padding: 0px 15px;
        white-space:nowrap;
    }
    .gene-call-table{
        margin-bottom: 0px;
    }
    .gene-section{
        max-width: 70px;
        margin-right: 5px;
    }
    .seq-buttons{
        margin-left: 0px;
        margin-bottom: 10px;
    }
    .long{
        white-space:normal;
        max-width: 300px;
    }
    #popover-panel{
        border: none;
        margin-bottom: 0px;
    }
</style>
<script type="text/javascript">
    // Binding template to the Popover Content
    $(document).ready(function () {
        $('[data-toggle="popover"]').popover({
        sanitize: false,
        html : true,
        content: function() {
            var content = $(this).attr("data-popover-content");
            return $(content).children(".popover-body").html();
        }
    });
})

//Closing popover if click somewhere else on the page.
$('body').on('click', function (e) {
    $('[data-toggle="popover"]').each(function () {
        if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
            $(this).popover('hide');
        }
    });
});

function show_sequence_modal(title, content) {
  // remove previous modal window
  $('.modal-sequence').modal('hide');
  $('.modal-sequence').remove();

  $('body').append('<div class="modal modal-sequence" style="z-index: 10000;"> \
      <div class="modal-dialog"> \
          <div class="modal-content"> \
              <div class="modal-header"> \
                  <button class="close" data-dismiss="modal" type="button"><span>&times;</span></button> \
                  <h4 class="modal-title">' + title + '</h4> \
              </div> \
              <div class="modal-body"> \
                      <textarea class="form-control" style="width: 100%; height: 100%; font-family: monospace;" rows="16" onclick="$(this).select();" readonly>' + (content.startsWith('>') ? content : '>' + content) + '</textarea> \
              </div> \
              <div class="modal-footer"> \
                  <button class="btn btn-default" data-dismiss="modal" type="button">Close</button> \
              </div> \
          </div> \
      </div> \
  </div>');
  $('.modal-sequence').modal('show');
  $('.modal-sequence textarea').trigger('click');
}

function show_sequence(header, sequence) {
    show_sequence_modal('Gene DNA Sequence', header + '\n' + sequence);
}

function show_aa_sequence(header, aa_sequence) {
    show_sequence_modal('Gene Amino Acid Sequence', header + '\n' + aa_sequence);
}

</script>
</body>
</html>
