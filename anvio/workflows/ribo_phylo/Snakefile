# -*- coding: utf-8

import argparse
import os
import pandas as pd

import anvio
import anvio.utils as u
import anvio.workflows as w

from anvio.errors import ConfigError
from anvio.workflows.ribo_phylo import RibosomalPhylogeneticsWorkflow

__author__ = "Matthew S. Schechter"
__copyright__ = "Copyright 2017, The anvio Project"
__credits__ = []
__license__ = "GPL 3.0"
__version__ = anvio.__version__
__maintainer__ = "Matthew S. Schechter"
__email__ = "mschechter@uchicago.edu"


M = RibosomalPhylogeneticsWorkflow(argparse.Namespace(config=config))
M.init()
dirs_dict = M.dirs_dict


rule ribo_phylo_workflow_target_rule:
    input: M.target_files

rule anvi_get_sequences_for_hmm_hits_ribosomal_proteins:
    """Extract all ribosomal proteins (Ribosomal_protein_list.txt) from metagenomes and genomes in samples.txt."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "anvi_get_sequences_for_hmm_hits_ribosomal_proteins_{sample_name}_{ribosomal_protein_name}.log")
    input: os.path.join(M.contig_dir, "{sample_name}-contigs.db")
    output: os.path.join(dirs_dict['EXTRACTED_RIBO_PROTEINS_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_hmm_hits_all.fasta")
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
	shell:
		"anvi-get-sequences-for-hmm-hits -c {input} \
                                         --hmm-source Bacteria_71 \
                                         --get-aa-sequences \
                                         --gene-name {wildcards.ribosomal_protein_name} \
                                         -o {output} 2> {log}"

rule anvi_estimate_scg_taxonomy_for_ribosomal_proteins:
    """Retrieve taxonomy from extract ribosomal proteins"""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "anvi_estimate_scg_taxonomy_for_ribosomal_proteins_{sample_name}_{ribosomal_protein_name}.log")
    input: os.path.join(M.contig_dir, "{sample_name}-contigs.db")
    output: os.path.join(dirs_dict['EXTRACTED_RIBO_PROTEINS_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_estimate_scg_taxonomy_results.tsv")
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
	shell:
		"anvi-estimate-scg-taxonomy -c {input} \
                                 	--metagenome-mode \
                                 	--scg-name-for-metagenome-mode {wildcards.ribosomal_protein_name} \
                                 	-o {output} 2> {log}"




rule filter_for_scg_sequences_and_metadata:
    """This rule will..."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "filter_for_scg_sequences_and_metadata_{sample_name}_{ribosomal_protein_name}.log")
    input:
        SCG_taxonomy = os.path.join(dirs_dict['EXTRACTED_RIBO_PROTEINS_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_estimate_scg_taxonomy_results.tsv"),
        fasta = os.path.join(dirs_dict['EXTRACTED_RIBO_PROTEINS_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_hmm_hits_all.fasta")
    output:
        fasta_filtered = os.path.join(dirs_dict['FILTERED_RIBO_PROTEINS_SEQUENCES_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}.fasta"),
        misc_data = os.path.join(dirs_dict['FILTERED_RIBO_PROTEINS_SEQUENCES_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_misc_data.tsv")

    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
    script:
        "scripts/filter_for_scg_sequences_and_metadata.py"


rule cat_ribo_proteins_to_one_fasta:
    """This rule will..."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "cat_ribo_proteins_to_one_fasta_{ribosomal_protein_name}.log")
    input: expand(os.path.join(dirs_dict['FILTERED_RIBO_PROTEINS_SEQUENCES_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}.fasta"), sample_name = M.sample_name_list, ribosomal_protein_name = M.Ribosomal_protein_list)
    output: os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}.fasta"),
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
    shell:
        "cat {input} >> {output}"


rule anvi_reformat_fasta_ribosomal_protein_file:
    """This rule will..."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "anvi_reformat_fasta_ribosomal_protein_file_{ribosomal_protein_name}.log")
    input: os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}.fasta")
    output: 
        fasta = os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_renamed.fasta"),
        report_file = os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_reformat_report_all.txt")
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
    shell:
        "anvi-script-reformat-fasta {input} \
                              --simplify-names \
                              --report-file {output.report_file} \
                              -o {output.fasta} >> {log} 2>&1"

rule cat_misc_data_to_one_file:
    """This rule will..."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "cat_ribo_proteins_to_one_fasta_{ribosomal_protein_name}.log")
    input: expand(os.path.join(dirs_dict['FILTERED_RIBO_PROTEINS_SEQUENCES_TAXONOMY_DIR'], "{sample_name}", "{sample_name}_{ribosomal_protein_name}_misc_data.tsv"), sample_name = M.sample_name_list, ribosomal_protein_name = M.Ribosomal_protein_list)
    output: os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_misc_data.tsv"),
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
    shell:
        "cat {input} >> {output}"


rule join_renamed_fasta_with_misc_data:
    """This rule will..."""

    version: 1.0
    log: os.path.join(dirs_dict['LOGS_DIR'], "join_renamed_fasta_with_misc_data_{ribosomal_protein_name}.log")
    input:
        misc_data_all = os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_misc_data.tsv"),
        reformat_report_all = os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_reformat_report_all.txt")
    output: misc_data_final = os.path.join(dirs_dict['RIBOSOMAL_PROTEIN_FASTAS'], "{ribosomal_protein_name}_misc_data_final.tsv")
    threads: M.T('anvi_get_sequences_for_hmm_hits_ribosomal_proteins')
    script:
        "scripts/join_renamed_fasta_with_misc_data.py"



# RIBOSOMAL_PROTEIN = ["Ribosomal_L16"]
# # RIBOSOMAL_PROTEIN = ["Ribosomal_L16", "Ribosomal_L17","Ribosomal_S2", "Ribosomal_S3_C", "Ribosomal_S7", "Ribosomal_L17", "Ribosomal_L22", "Ribosomal_S9", "Ribosomal_L20", "Ribosomal_L2"]

# rule all:
#     input:
#         expand("{RP}_protein/04_trees/{RP}.contree", RP=RIBOSOMAL_PROTEIN)

# # For simplicity, the rules here are designed to be read in order or task

# 1. Initial alignment, trim, and removal of sequences with 50% gaps or more
# rule align:
# 	input:
# 		"{ribosomal_protein}_protein/02_{ribosomal_protein}_all_renamed_NR_rep_seq.fasta"
# 	output:
# 		"{ribosomal_protein}_protein/01_aligned/{ribosomal_protein}_all_aligned.fasta"
# 	threads: 35
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_muscle.log"
# 	shell:
# 		"muscle -in {input} \
# 				-out {output} 2> {log}"

# rule trim_alignment:
# 	input:
# 		"{ribosomal_protein}_protein/01_aligned/{ribosomal_protein}_all_aligned.fasta"
# 	output:
# 		"{ribosomal_protein}_protein/02_trimmed/{ribosomal_protein}_all_aligned_trimmed.fasta"
# 	threads: 10
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_trimal.log"
# 	shell:
# 		"trimal -in {input} \
# 				-out {output} \
# 				-gt 0.50 2> {log}"

# rule remove_gaps:
# 	input:
# 		"{ribosomal_protein}_protein/02_trimmed/{ribosomal_protein}_all_aligned_trimmed.fasta"
# 	params:
# 		seq_counts_tsv="{ribosomal_protein}_protein/03_gaps_removed/{ribosomal_protein}_gaps_counts"
# 	output:
# 		"{ribosomal_protein}_protein/03_gaps_removed/{ribosomal_protein}_all_aligned_trimmed_gaps_removed.fasta"
# 	threads: 10
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_remove_gaps.log"
# 	shell:
# 		"anvi-script-reformat-fasta {input} \
# 									-o {output} \
# 									--max-percentage-gaps 50 \
# 									--export-gap-counts-table {params.seq_counts_tsv} >> {log} 2>&1"

# # 2. Remove sequences that have an outlier set of gaps in a sequences
# # - this step further refine the MSA by removing more sequences that have too many gaps.
# # to make this smarter, we will rely on the standard outlier threshold of 1.5*IQR and remove any
# # sequences with more gaps than that. To accomplish this the following steps will be taken:
# # * Get the distribution of gaps counts per sequences
# # * calculate the outlier threshold 1.5*IQR
# # * remove sequences greater than that threshold

# rule get_gap_count_distribution:
# 	input:
# 		"{ribosomal_protein}_protein/03_gaps_removed/{ribosomal_protein}_all_aligned_trimmed_gaps_removed.fasta"
# 	output:
# 		seq_counts_tsv="{ribosomal_protein}_protein/03_gaps_removed/{ribosomal_protein}_gaps_counts"
# 	threads: 5
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}get_gap_count_distribution.log"
# 	shell:
# 		"anvi-script-reformat-fasta {input} \
#  									--export-gap-counts-table {output.seq_counts_tsv} >> {log} 2>&1"

# # rule find_IQR:
# # 	input:
# # 		"{ribosomal_protein}_protein/04_remove_poorly_aligned_sequences/{ribosomal_protein}_gaps_counts.tsv"
# # 	run:
# # 		pd.read_csv({import})]

# # rule filter_out_outlier_sequences


# # 3. Re-prepare MSA for tree calculation
# # Repeat step 1. now that we have the final set of sequences that don't have too many gaps

# rule align_2:
# 	input:
# 		"{ribosomal_protein}_protein/03_gaps_removed/Ribosomal_L16_all_aligned_trimmed_gaps_removed_max_6.fasta"
# 	output:
# 		"{ribosomal_protein}_protein/04_re_aligned/{ribosomal_protein}_all_aligned.fasta"
# 	threads: 30
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_muscle_2.log"
# 	shell:
# 		"muscle -in {input} \
# 				-out {output} 2> {log}"

# rule trim_alignment_2:
# 	input:
# 		"{ribosomal_protein}_protein/04_re_aligned/{ribosomal_protein}_all_aligned.fasta"
# 	output:
# 		"{ribosomal_protein}_protein/05_re_trimmed/{ribosomal_protein}_all_aligned_trimmed.fasta"
# 	threads: 10
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_trimal_2.log"
# 	shell:
# 		"trimal -in {input} \
# 				-out {output} \
# 				-gt 0.50 2> {log}"

# rule remove_gaps_2:
# 	input:
# 		"{ribosomal_protein}_protein/05_re_trimmed/{ribosomal_protein}_all_aligned_trimmed.fasta"
# 	params:
# 		seq_counts_tsv="{ribosomal_protein}_protein/06_gaps_re_removed/{ribosomal_protein}_gaps_counts"
# 	output:
# 		"{ribosomal_protein}_protein/06_gaps_re_removed/{ribosomal_protein}_all_aligned_trimmed_gaps_removed.fasta"
# 	threads: 10
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_remove_gaps_2.log"
# 	shell:
# 		"anvi-script-reformat-fasta {input} \
# 									-o {output} \
# 									--max-percentage-gaps 50 \
# 									--export-gap-counts-table {params.seq_counts_tsv} >> {log} 2>&1"


# # 4. Calculate the tree, FINALLY

# rule calculate_tree:
# 	input:
# 		"{ribosomal_protein}_protein/03_gaps_removed/{ribosomal_protein}_all_aligned_trimmed_gaps_removed_maxgap_4.fasta"
# 	params:
# 		outfile="{ribosomal_protein}_protein/04_trees/{ribosomal_protein}"
# 	output:
# 		"{ribosomal_protein}_protein/04_trees/{ribosomal_protein}.contree"
# 	threads: 39
# 	log:
# 		"{ribosomal_protein}_protein/00_logs/{ribosomal_protein}_iqtree.log"
# 	shell:
# 		"iqtree -s {input} \
# 				-nt AUTO \
# 				-m MFP \
# 				-bb 1000 \
# 				-pre {params.outfile} >> {log} 2>&1"